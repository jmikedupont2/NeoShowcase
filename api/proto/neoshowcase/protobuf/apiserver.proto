syntax = "proto3";
package neoshowcase.protobuf;
option go_package = "github.com/traPtitech/neoshowcase/pkg/interface/grpc/pb";

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "neoshowcase/protobuf/null.proto";

enum BuildType {
  RUNTIME = 0;
  STATIC = 1;
}

enum ApplicationState {
  IDLE = 0;
  DEPLOYING = 1;
  RUNNING = 2;
  ERRORED = 3;
}

enum AuthenticationType {
  OFF = 0;
  SOFT = 1;
  HARD = 2;
}

message ApplicationConfig {
  bool use_mariadb = 1;
  bool use_mongodb = 2;
  string base_image = 3;
  string build_cmd = 4;
  string entrypoint_cmd = 5;
  AuthenticationType authentication = 6;
}

message Website {
  string id = 1;
  string fqdn = 2;
  int32 port = 3;
}

message CreateWebsiteRequest {
  string fqdn = 1;
  int32 port = 2;
}

message Application {
  string id = 1;
  string repository_url = 2;
  string branch_name = 3;
  BuildType build_type = 4;
  ApplicationState state = 5;
  string current_commit = 6;
  string want_commit = 7;
  ApplicationConfig config = 8;
  repeated Website websites = 9;
}

message ApplicationEnvironmentVariable {
  string key = 1;
  string value = 2;
}

message ApplicationEnvironmentVariables {
  repeated ApplicationEnvironmentVariable variables = 1;
}

message MariaDbKey {
  string host = 1;
  string database = 2;
  string user = 3;
  string password = 4;
}

message MongoKey {
  string host = 1;
  string database = 2;
  string user = 3;
  string password = 4;
}

message ApplicationKeys {
  MariaDbKey mariaDbKey = 1;
  MongoKey mongoKey = 2;
}

message ApplicationBuildArtifact {
  string url = 1;
}

message ApplicationOutput {
  string output = 1;
}

message Build {
  enum BuildStatus {
    BUILDING = 0;
    SUCCEEDED = 1;
    FAILED = 2;
    CANCELLED = 3;
    QUEUED = 4;
    SKIPPED = 5;
  }
  string id = 1;
  string commit = 2;
  BuildStatus status = 3;
  google.protobuf.Timestamp started_at = 4;
  neoshowcase.protobuf.NullTimestamp finished_at = 5;
}

message BuildLog {
  string output = 1;
}

message GetApplicationsResponse {
  repeated Application applications = 1;
}

message CreateApplicationRequest {
  string repository_url = 1;
  string branch_name = 2;
  BuildType build_type = 3;
  ApplicationConfig config = 4;
  repeated CreateWebsiteRequest websites = 5;
}

message ApplicationIdRequest {
  string id = 1;
}

message GetApplicationBuildsResponse {
  repeated Build builds = 1;
}

message GetApplicationBuildRequest {
  string build_id = 1;
}

message GetApplicationBuildLogRequest {
  string build_id = 1;
}

message SetApplicationEnvironmentVariableRequest {
  string application_id = 1;
  string key = 2;
  string value = 3;
}

service ApplicationService {
  rpc GetApplications(google.protobuf.Empty) returns (GetApplicationsResponse);
  rpc CreateApplication(CreateApplicationRequest) returns (Application);
  rpc GetApplication(ApplicationIdRequest) returns (Application);
  rpc DeleteApplication(ApplicationIdRequest) returns (google.protobuf.Empty);
  rpc GetApplicationBuilds(ApplicationIdRequest) returns (GetApplicationBuildsResponse);
  rpc GetApplicationBuild(GetApplicationBuildRequest) returns (Build);
  rpc GetApplicationBuildLog(GetApplicationBuildLogRequest) returns (BuildLog);
  rpc GetApplicationBuildArtifact(ApplicationIdRequest) returns (ApplicationBuildArtifact);
  rpc GetApplicationEnvironmentVariables(ApplicationIdRequest) returns (ApplicationEnvironmentVariables);
  rpc SetApplicationEnvironmentVariable(SetApplicationEnvironmentVariableRequest) returns (google.protobuf.Empty);
  rpc GetApplicationOutput(ApplicationIdRequest) returns (ApplicationOutput);
  rpc GetApplicationKeys(ApplicationIdRequest) returns (ApplicationKeys);
  rpc StartApplication(ApplicationIdRequest) returns (google.protobuf.Empty);
  rpc StopApplication(ApplicationIdRequest) returns (google.protobuf.Empty);
}
