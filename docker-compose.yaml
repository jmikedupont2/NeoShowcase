services:
  ns:
    build:
      context: .
      target: ns
    command: run --debug --loglevel=trace
    restart: always
    environment:
      NS_APISERVER_DEBUG: "true"
      NS_APISERVER_DB_HOST: "mysql"
      NS_APISERVER_MARIADB_HOST: "mysql"
      NS_APISERVER_MONGODB_HOST: "mongo"
      NS_APISERVER_BUILDER_ADDR: "ns-builder:10000"
      NS_APISERVER_BUILDER_INSECURE: "true"
      NS_APISERVER_SSGEN_ADDR: "ns-ssgen:10000"
      NS_APISERVER_SSGEN_INSECURE: "true"
      NS_APISERVER_GRPC_PORT: "5000"
      NS_APISERVER_HTTP_PORT: "8080"
      NS_APISERVER_HTTP_DEBUG: "true"
      NS_APISERVER_IMAGE_REGISTRY: "registry.local.tokyotech.org"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./local-dev/neoshowcase:/data
      - ./local-dev/traefik:/opt/traefik/conf
    ports:
      - "5009:5000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ns_admin.rule=Host(`local.tokyotech.org`)"
      - "traefik.http.routers.ns_admin.service=ns_admin"
      - "traefik.http.services.ns_admin.loadbalancer.server.port=8080"
      - "traefik.http.routers.ns_grpc.rule=Host(`grpc.local.tokyotech.org`)"
      - "traefik.http.routers.ns_grpc.service=ns_grpc"
      - "traefik.http.services.ns_grpc.loadbalancer.server.port=5000"
    depends_on:
      - mysql
    networks:
      - default

  ns-mc:
    build:
      context: .
      target: ns-mc
    restart: always
    ports:
      - "5005:8081"
    networks:
      - default

  ns-builder:
    build:
      context: .
      target: ns-builder
    command: run --debug --loglevel=trace
    restart: always
    environment:
      NS_BUILDER_BUILDKIT_ADDRESS: "tcp://buildkitd:1234"
      NS_BUILDER_DB_HOST: "mysql"
    volumes:
      - ./local-dev/neoshowcase/artifacts:/neoshowcase/artifacts
      - ./local-dev/neoshowcase/buildlogs:/neoshowcase/buildlogs
    ports:
      - "5006:10000"
    depends_on:
      - mysql
      - buildkitd
    networks:
      - default

  ns-ssgen:
    build:
      context: .
      target: ns-ssgen
    command: run --debug --loglevel=trace
    restart: always
    environment:
      NS_SSGEN_DB_HOST: "mysql"
      NS_SSGEN_ARTIFACTSROOT: "/srv/artifacts"
    volumes:
      - ./local-dev/staticsite/artifacts:/srv/artifacts
      - ./local-dev/neoshowcase/artifacts:/neoshowcase/artifacts
    ports:
      - "5007:10000"
      - "5008:80"
    labels:
      - "traefik.enabled=true"
      - "traefik.http.routers.ns_ssgen.rule=HostRegexp(`.*`)"
      # lowest priority
      - "traefik.http.routers.ns_ssgen.priority=1"
      - "traefik.http.services.ns_ssgen.loadbalancer.server.port=80"
    depends_on:
      - mysql
    networks:
      - default

  registry:
    image: registry:2
    restart: always
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
      REGISTRY_HTTP_ADDR: :80
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.registry.rule=Host(`registry.local.tokyotech.org`)"
      - "traefik.http.services.registry.loadbalancer.server.port=80"
    networks:
      default:
        aliases:
          - "registry.local.tokyotech.org"

  registry-frontend:
    image: konradkleine/docker-registry-frontend:v2
    restart: always
    ports:
      - "5003:80"
    environment:
      ENV_DOCKER_REGISTRY_HOST: registry.local.tokyotech.org
      ENV_DOCKER_REGISTRY_PORT: 80
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.registry_frontend.rule=Host(`registry-frontend.local.tokyotech.org`)"
      - "traefik.http.services.registry_frontend.loadbalancer.server.port=80"
    networks:
      - default

  buildkitd:
    image: moby/buildkit:latest
    restart: always
    privileged: true
    ports:
      - "5002:1234"
    command: --addr tcp://0.0.0.0:1234
    volumes:
      - ./local-dev/buildkitd/buildkitd.toml:/etc/buildkit/buildkitd.toml
    networks:
      - default

  mysql:
    image: mariadb
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: neoshowcase
    command: mysqld --character-set-server=utf8 --collation-server=utf8_general_ci
    ports:
      - "5004:3306"
    networks:
      - default
      - apps

  mongo:
    image: mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
    ports:
      - "5010:27017"
    networks:
      - default
      - apps

  adminer:
    image: adminer:4.7.5
    restart: always
    environment:
      ADMINER_DEFAULT_SERVER: mysql
      ADMINER_DESIGN: nette
    ports:
      - "5001:8080"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adminer.rule=Host(`adminer.local.tokyotech.org`)"
      - "traefik.http.services.adminer.loadbalancer.server.port=8080"
    networks:
      - default

  traefik:
    image: traefik:v2.3
    restart: always
    command:
      - --api.insecure=true
      - --providers.docker
      - --providers.docker.exposedByDefault=false
      - --providers.file
      - --providers.file.directory=/opt/neoshowcase/conf
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./local-dev/traefik:/opt/neoshowcase/conf
    networks:
      - default
      - apps

networks:
  default: { }
  apps: { }
